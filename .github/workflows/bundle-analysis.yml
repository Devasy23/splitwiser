name: Bundle Analysis

on:
  pull_request:
    paths:
      - 'frontend/**'
    branches: [ main, master ]
  push:
    paths:
      - 'frontend/**'
    branches: [ main, master ]

jobs:
  bundle-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Dependencies
      run: npm install
      working-directory: ./frontend
    
    - name: Setup EAS
      uses: expo/expo-github-action@v8
      with:
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}

    - name: Build for Bundle Analysis
      run: npx expo export --platform web --output-dir web-build
      working-directory: ./frontend
    
    - name: Analyze Bundle Size
      working-directory: ./frontend
      run: |
        # Install Metro bundle analyzer and bc for calculations
        npm install --no-save @expo/metro-config metro-visualizer
        sudo apt-get update && sudo apt-get install -y bc
        
        # Generate bundle report using Metro
        echo "üìä Analyzing bundle size for Expo/React Native project..."
        
        # Check if web-build directory exists
        if [ -d "web-build" ]; then
          echo "‚úÖ Web build directory found"
          ls -la web-build/
          
          # Calculate bundle sizes
          if [ -d "web-build/static/js" ]; then
            echo "üìÅ JavaScript bundle files:"
            find web-build/static/js -name "*.js" -type f -exec ls -lh {} \; | awk '{print $5 " " $9}'
            
            # Calculate total bundle size
            TOTAL_SIZE=$(find web-build/static/js -name "*.js" -type f -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')
            TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc -l)
            echo "üìä Total JavaScript bundle size: ${TOTAL_SIZE_MB} MB"
            
            # Create a simple analysis report
            echo "# Bundle Analysis Report" > bundle-analysis.md
            echo "" >> bundle-analysis.md
            echo "## Bundle Size Summary" >> bundle-analysis.md
            echo "- Total JavaScript bundle size: **${TOTAL_SIZE_MB} MB**" >> bundle-analysis.md
            echo "" >> bundle-analysis.md
            echo "## Individual Files" >> bundle-analysis.md
            find web-build/static/js -name "*.js" -type f -exec ls -lh {} \; | awk '{print "- " $9 ": " $5}' >> bundle-analysis.md
            
            cat bundle-analysis.md
          else
            echo "‚ùå No JavaScript bundles found in web-build/static/js"
          fi
        else
          echo "‚ùå No web-build directory found after export"
          echo "üìÅ Available directories:"
          ls -la
        fi
    
    - name: Upload Bundle Analysis Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bundle-analysis-report
        path: frontend/bundle-analysis.md
        retention-days: 30
    
    - name: Upload Bundle Analysis to Codecov
      uses: codecov/codecov-action@v4
      if: github.actor != 'dependabot[bot]' && hashFiles('frontend/bundle-analysis.md') != ''
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        flags: bundle,frontend,javascript
        name: "Bundle Analysis"
        fail_ci_if_error: false
    
    - name: Bundle Analysis Skipped
      if: github.actor == 'dependabot[bot]'
      run: echo "üì¶ Bundle analysis skipped for Dependabot PR"
